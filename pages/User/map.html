<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../style/style.css">
    <link rel="stylesheet" href="../../style/styleHome.css">
    <link rel="stylesheet" href="../../style/styleReport.css">
    <link rel="stylesheet" href="../../bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://kit.fontawesome.com/66c0e9ccd8.js" crossorigin="anonymous">
    </script>
    <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>

    <!--Directory ko ito kung saan nakalagay yung bootstrap ko. Papalitan nalang ng link ng bootstrap online-->

</head>

<body>

    <nav class="navbar navbar-expand-md" style="background-color: #1f497d; height: 100%">
        <div class="container-fluid">
            <button class="navbar-toggler bg-light border-light" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="row mx-auto">
                <a class="image" href="#">
                    <img src="../../Logo.png" class="img-fluid" width="150px" height="60">
                </a>
            </div>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul id="items" class="navbar-nav fs-3">
                    <li type="button" class="selectedItem border-responsive">
                        <a class="nav-link text-light" name="Home" aria-current="true" href="home.html">Home</a>
                    </li>
                    <li type="button" class="selectedItem border-responsive active">
                        <a class="nav-link text-light" name="mapView" href="map.html">Map View</a>
                    </li>
                    <li type="button" class="selectedItem border-responsive">
                        <a class="nav-link text-light" name="createReport" href="createReport.html">Create Report</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <h2 class="mt-5 mb-3 d-flex justify-content-center">Crime Statistics</h2>
        <div class="sizeCanvas col-12 mb-5">
            <canvas id="myChart"></canvas>
        </div>

        <h2 class="mt-5 mb-3 d-flex justify-content-center">Crime Density Map</h2>
        <div class="map col-12">
            <div id="map"></div>

            <input type="text" id="inputColor" placeholder="Please input the street and color" style="width: 300px">
            <button onclick="updateColors()">Confirm</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Initialize the map
        var map = L.map('map').setView([14.358083677714449, 121.0583616614907], 19);

        // Add a tile layer (you can use different tile providers)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Create circles with default colors
        var circleStreet4th = L.circle([14.358169425879144, 121.05766965157575], {
            color: 'transparent',
            fillColor: 'red', // Default color
            fillOpacity: 0.5,
            radius: 30
        }).addTo(map);

        var circleStreet5th = L.circle([14.358366906376673, 121.05825437313592], {
            color: 'transparent',
            fillColor: 'red', // Default color
            fillOpacity: 0.5,
            radius: 30
        }).addTo(map);


        var circleStreet2nd = L.circle([14.357803047123392, 121.05888201004971], {
            color: 'transparent',
            fillColor: 'red', // Default color
            fillOpacity: 0.5,
            radius: 30
        }).addTo(map);

        function updateColors() {
            var inputColor = document.getElementById("inputColor").value.toLowerCase();

            // Update the fill color of circles based on input
            if (inputColor === "4th blue") {
                circleStreet4th.setStyle({
                    fillColor: 'blue'
                });
            } else if (inputColor === "5th blue") {
                circleStreet5th.setStyle({
                    fillColor: 'blue'
                });
            } else if (inputColor === "2nd blue") {
                circleStreet2nd.setStyle({
                    fillColor: 'blue'
                });
            }
        }

        function test() {
            circleStreet2nd.on('click', function(e) {
                var color = circleStreet2nd.options.fillColor;
                console.log(`Circle color: ${color}`);
            });
        }
        const eventHandler = {
            maps: map,
            handleMapClick: function(e) {
                console.log('Map clicked at:', e.latlng)
            },
            handleCircleClick: test
        };

        L.DomEvent.on(map, 'click', eventHandler.handleMapClick);
        L.DomEvent.on(map, 'click', eventHandler.handleCircleClick);


        const eventHandlers = {
            handleClick: function(e) {
                console.log("Button clicked! This refers to:", this);
            },
            handleMouseOver: function(e) {
                console.log("Mouse over button! This refers to:", this);
            },
            handleOnMouseOver: function(e) {
                console.log("Location is: ", e.latlng);
            }
        };

        // Define a context object
        const contextObject = {
            contextName: 'Context Object',
        };

        // Custom `on` function to attach multiple event handlers
        function on(el, eventMap, context) {
            for (let [eventType, handler] of Object.entries(eventMap)) {
                el.addEventListener(eventType, handler.bind(context));
            }
        }

        // Use the custom `on` function to attach event handlers
        on(map, {
            click: eventHandlers.handleClick,
            mouseover: eventHandlers.handleMouseOver,
            onclick: eventHandlers.handleOnMouseOver,
        }, contextObject);

        // Connect to the Socket.IO server
        const socket = io('http://localhost:3000');

        // Listen for new crime reports
        socket.on('new_report', (report) => {
            console.log('New report received:', report);

            // Display a real-time notification (e.g., an alert or a custom notification UI)
            alert(`New report: ${report.crimeType} reported at ${report.street}`);

            // Add a new marker to the map for the reported crime
            const marker = L.marker([report.latitude, report.longitude]).addTo(map);
            marker.bindPopup(`
                <b>Crime Type:</b> ${report.crimeType}<br>
                <b>Description:</b> ${report.description}<br>
                <b>Reported at:</b> ${report.street}
            `).openPopup();
        });

        // Fetch existing reports to display on the map
        fetch('http://localhost:3000/reports')
            .then((res) => res.json())
            .then((reports) => {
                reports.forEach((report) => {
                    const marker = L.marker([report.latitude, report.longitude]).addTo(map);
                    marker.bindPopup(`
                        <b>Crime type: ${report.crimeType}</b><br>
                        <p>Description: ${report.description}</p>
                        <p>Reported by: ${report.firstName} ${report.lastName}</p>
                        <p>Contact: ${report.contact}</p>
                    `);
                });
            })
            .catch((err) => console.error('Error fetching reports:', err));

        
    </script>

    <script src="../../bootstrap/js/bootstrap.js"></script>
    <!--Directory ko ito kung saan nakalagay yung bootstrap ko. Papalitan nalang ng link ng bootstrap online-->
    <script src="../../script/script.js"></script>
</body>

</html>