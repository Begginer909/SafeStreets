<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="../../style/styleStaff.css">
    <title>Crime Reporting System</title>
</head>
<body>
    <div class="container mt-4">
        <div class="notification-container">
            <div class="card notification-card" id="notification-card" data-bs-toggle="modal" data-bs-target="#notification-modal">
              <div class="card-body text-center">
                <h5>New Reports</h5>
                <span class="badge bg-danger" id="report-count">0</span>
              </div>
            </div>
        </div>
        
          <!-- Modal -->
          <div class="modal fade" id="notification-modal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="false">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="notificationModalLabel">Notifications</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <table id="notification-table" class="table table-bordered table-hover">
                    <thead>
                      <tr>
                        <th>Account ID</th>
                        <th>Witness Name</th>
                        <th>Contact</th>
                        <th>Type of Crime</th>
                        <th>Description</th>
                        <th>Location</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- Dynamic rows will be added here -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                Are you sure you want to delete this notification? This action cannot be undone.
                </div>
                <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton">Delete</button>
                </div>
            </div>
        </div>
    </div>
  

    <div id="map" style="height: 500px;"></div>


<script>
    // Initialize Socket.IO
    const socket = io('http://localhost:3000');

    // Listen for new report notifications
    socket.on('new_notification', () => {
    const reportCount = document.getElementById('report-count');
    const currentCount = parseInt(reportCount.textContent, 10);
    reportCount.textContent = currentCount + 1;
    reportCount.classList.add('visible'); // Show the badge if not already visible
    });

    // Reset count when modal opens
    document.getElementById('notification-card').addEventListener('click', () => {
    document.getElementById('report-count').textContent = 0;
    document.getElementById('report-count').classList.remove('visible');
    });

</script>

<script>
// Reset count when modal opens
document.getElementById('notification-card').addEventListener('click', () => {
        document.getElementById('report-count').textContent = 0;
        document.getElementById('report-count').classList.remove('visible');
    });

    // Load notifications into modal
    document.getElementById('notification-card').addEventListener('click', async () => {
        const response = await fetch('http://localhost:3000/populatenotifications');
        const notifications = await response.json();
        const tbody = document.querySelector('#notification-table tbody');
        tbody.innerHTML = ''; // Clear previous data

        notifications.forEach((notification) => {
            const row = `
                <tr>
                    <td>${notification.accID}</td>
                    <td>${notification.firstName} ${notification.lastName}</td>
                    <td>${notification.contact}</td>
                    <td>${notification.crimeType}</td>
                    <td>${notification.description}</td>
                    <td>${notification.street}</td>
                    <td>
                        <button class="btn btn-primary btn-view" data-id="${notification.notificationID}">View</button>
                        <button class="btn btn-success btn-send" data-id="${notification.notificationID}">Send</button>
                        <button class="btn btn-danger btn-delete" data-id="${notification.notificationID}">Delete</button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    });

</script>

<script>
    // Map and modal interaction
    let map; // Declare a global variable for the map
    const mapContainer = document.getElementById('map');
    const modalElement = new bootstrap.Modal(document.getElementById('notification-modal'));
    let notificationToDelete = null; // Variable to store the notification ID to delete
    const deleteConfirmationModal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));

    document.addEventListener('click', async (e) => {
        if (e.target.classList.contains('btn-view')) {
            const notificationID = e.target.dataset.id;
            console.log(notificationID);

            // Fetch notification data
            const response = await fetch('http://localhost:3000/notifications/view', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notificationID }),
            });

            const data = await response.json();

            // Hide modal
            modalElement.hide();

            // Clear previous map instance
            if (map) {
                map.remove();
            }

            // Create new map instance
            map = L.map(mapContainer).setView([data.latitude, data.longitude], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            L.marker([data.latitude, data.longitude])
                .addTo(map)
                .bindPopup(`<b>${data.crimeType}</b><br>${data.description}`)
                .openPopup();
        }
        if (e.target.classList.contains('btn-send')) {
            const notificationID = e.target.dataset.id;
            await fetch('http://localhost:3000/notifications/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ notificationID }),
            });
            alert('Incident confirmed and users notified!');
            e.target.closest('tr').remove(); // Remove row from the table
        }
        if (e.target.classList.contains('btn-delete')) {
            // Store the notification ID and show the confirmation modal
            notificationToDelete = e.target.dataset.id;
            deleteConfirmationModal.show();
        }
    });

    // Handle delete confirmation
    document.getElementById('confirmDeleteButton').addEventListener('click', async () => {
        if (notificationToDelete) {
            try {
                // Send DELETE request to server
                const response = await fetch(`http://localhost:3000/notifications/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notificationID: notificationToDelete }),
                });

                if (!response.ok) {
                    throw new Error('Failed to delete notification.');
                }

                // Remove the deleted row from the table
                document.querySelector(`[data-id="${notificationToDelete}"]`).closest('tr').remove();
                alert('Notification deleted successfully!');
            } catch (error) {
                console.error(error);
                alert('An error occurred while deleting the notification.');
            } finally {
                notificationToDelete = null; // Reset notification ID
                deleteConfirmationModal.hide(); // Hide the modal
            }
        }
    });


</script>

    
</body>
</html>
